<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <title>Login</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link href="https://fonts.googleapis.com/css?family=Lato:300,400,700&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="css/style.login.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="shortcut icon" href="https://aguapuravianet.com.br/assets/images/logos/favicon.png" type="image/png">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        .field-icon {
            float: right;
            margin-right: 10px;
            margin-top: -28px;
            position: relative;
            z-index: 2;
            cursor: pointer;
        }
        .spinner-border {
            vertical-align: middle;
        }
    </style>
</head>
<body>
<div class="container" style="background-color: #F1F5F9; max-width: 100%;">
    <div class="wrapper fadeInDown" style="background-color: #F1F5F9;">
        <section class="ftco-section">
            <div class="container">
                <div class="row justify-content-center">
                </div>
                <div class="row justify-content-center align-items-center" style="min-height: 75vh;">
                    <div class="col-md-6 col-lg-5">
                        <div class="login-wrap p-4 p-md-5" style="background-color: #ffffff;">
                            <div class="icon d-flex align-items-center justify-content-center">
                                <img src="img/logo1.png" alt="Logo da Aguapura">
                            </div>
                            <h3 class="text-center mb-4">Login</h3>
                            <form id="loginForm" class="login-form">
                                <div class="form-group">
                                    <input type="email" id="email" class="form-control rounded-left" placeholder="E-mail" required>
                                </div>
                                <div class="form-group">
                                    <input type="password" id="password" class="form-control rounded-left" placeholder="Senha" required>
                                    <span id="togglePassword" class="fa fa-fw fa-eye field-icon toggle-password"></span>
                                </div>
                                <div class="form-group d-md-flex">
                                    <div class="w-50">
                                        <label class="checkbox-wrap checkbox-primary">Lembre-se de mim
                                            <input type="checkbox" id="rememberMe">
                                            <span class="checkmark"></span>
                                        </label>
                                    </div>
                                    <div class="w-50 text-md-right">
                                        <a href="recuperarsenha.html">Esqueci a senha</a>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <button type="submit" class="btn btn-primary rounded submit p-3 px-5">Entrar</button>
                                </div>
                            </form>
                            <div id="feedback" class="text-danger mt-3" style="display: none;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<script>
$(document).ready(function() {
    // Configurações
    const API_URL = 'https://localhost:8000/api/usuarios/login';
    const REDIRECT_URL = 'https://127.0.0.1:5501/dadosagua.html';
    
    // Mostrar/ocultar senha
    $('#togglePassword').click(function() {
        const input = $('#password');
        const icon = $(this);
        if (input.attr('type') === 'password') {
            input.attr('type', 'text');
            icon.removeClass('fa-eye').addClass('fa-eye-slash');
        } else {
            input.attr('type', 'password');
            icon.removeClass('fa-eye-slash').addClass('fa-eye');
        }
    });

    // Preencher e-mail salvo se "Lembrar-me" estava marcado
    const rememberedEmail = localStorage.getItem('rememberedEmail');
    if (rememberedEmail) {
        $('#email').val(rememberedEmail);
        $('#rememberMe').prop('checked', true);
    }

    // Validação de e-mail
    function validateEmail(email) {
        const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return re.test(email);
    }

    // Manipulador de login
    $('#loginForm').submit(function(e) {
        e.preventDefault();
        
        // Resetar feedback
        $('#feedback').hide().text('');
        
        // Obter valores
        const email = $('#email').val().trim();
        const password = $('#password').val();
        const rememberMe = $('#rememberMe').is(':checked');
        
        // Validação
        if (!email || !password) {
            showError('Por favor, preencha todos os campos');
            return;
        }
        
        if (!validateEmail(email)) {
            showError('Por favor, insira um e-mail válido');
            return;
        }
        
        // Configurar loading
        const btn = $(this).find('button[type="submit"]');
        btn.prop('disabled', true);
        btn.html('<span class="spinner-border spinner-border-sm" role="status"></span> Entrando...');
        
        // Fazer requisição
        $.ajax({
            url: API_URL,
            type: 'POST',
            contentType: 'application/json',
            dataType: 'json',
            data: JSON.stringify({
                email: email,
                password: password
            }),
            success: function(response) {
                // Armazenar token
                localStorage.setItem('jwtToken', response.token);
                
                // Lembrar e-mail se selecionado
                if (rememberMe) {
                    localStorage.setItem('rememberedEmail', email);
                } else {
                    localStorage.removeItem('rememberedEmail');
                }
                
                // Redirecionar
                window.location.href = REDIRECT_URL;
            },
            error: function(xhr) {
                let errorMessage = 'Erro ao fazer login';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                } else if (xhr.status === 0) {
                    errorMessage = 'Erro de conexão. ';
                } else if (xhr.status === 401) {
                    errorMessage = 'E-mail ou senha incorretos';
                }
                showError(errorMessage);
            },
            complete: function() {
                btn.prop('disabled', false);
                btn.text('Entrar');
            }
        });
    });
    
    function showError(message) {
        const feedback = $('#feedback');
        feedback.text(message).fadeIn();
    }
});
</script>
</body>
</html>